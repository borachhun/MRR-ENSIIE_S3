---
title: "MRR Project 2022 - Project Ocean"
author: "Piseth KHENG, Borachhun YOU"
date: "07 November 2022"
output: pdf_document
---

# Install required packages
```{r}

```

# Load data
```{r}
library(R.matlab)
mat_data <- readMat("VectLB19922008.mat")
df <- as.data.frame(mat_data$Vect)

# add column names
colnames(df) <- unlist(mat_data$labels)

# convert all CHL i to log10 scale
df[, 23:40] <- log10(df[, 23:40])

# remove THERM 2 - THERM 18
df <- df[, -(6:22)]

colnames(df)
```

# Data at BATS
```{r}
# data of BATS location
bats <- df[(df$latitude>=31) & (df$latitude<=33) & (df$longitude<=-63) & (df$longitude>=-65), ]

# remove lat and long from bats data
bats <- bats[, -which(names(bats) %in% c("latitude", "longitude"))]
```

# Data at BATS sorted by year with previous 5days
```{r}
sorted_bats <- bats[order(bats$year),]

library(data.table)
sorted_bats$`Prev CHL 1` <- shift(sorted_bats$`CHL 1`)
sorted_bats <- sorted_bats[-1,]XandY_dateConverted$`sin5days` <- sin(2*pi* XandY$`5days` /73)
XandY_dateConverted$`cos5days` <- cos(2*pi* XandY$`5days` /73)
sorted_bats
```

# Spatial analysis
```{r}
# remove lat,long (26,27)
nine_locations <- df[(round(df$latitude)==32 & round(df$longitude)==-64), -c(26,27)]
i <- 1
for (lat in unique(round(df$latitude))) {
  for (long in unique(round(df$longitude))) {
    if (!(lat==32 & long==-64)) {
      # remove CHL 2-18, 5days, year, lat, long (7:27)
      tmp <- df[(round(df$latitude)==lat & round(df$longitude)==long), -(7:27)]
      colnames(tmp) <- paste(colnames(tmp), i)
      nine_locations <- cbind(nine_locations, tmp)
      i <- i + 1
    }
  }
}

# convert date to sin and cos
nine_locations$`sin5days` <- sin(2*pi* nine_locations$`5days` /73)
nine_locations$`cos5days` <- cos(2*pi* nine_locations$`5days` /73)
# remove 5days (24)
nine_locations <- nine_locations[, -24]

colnames(nine_locations)
```

# Split data by year
```{r}
subset_year <- split(
  x = unique(nine_locations$year),
  f = sample(rep(1:5, times=c(4,4,3,3,3)))
)
# remove year (24)
train_data <- nine_locations[nine_locations$year %in% c(subset_year[[1]], subset_year[[2]], subset_year[[3]]), -24]
test_data <- nine_locations[nine_locations$year %in% subset_year[[4]], -24]
validate_data <- nine_locations[nine_locations$year %in% subset_year[[5]], -24]

colnames(train_data)
```

# Predict all CHL i

```{r}
rss_linear <- c()
rss_forward <- c()
rss_ridge <- c()
rss_lasso <- c()

# loop for CHL 2-18
for (i in 1:17) {
  # 7:23 = CHL 2-18
  train_data_CHLi <- train_data[, -(c(7:23)[-i])]
  test_data_CHLi <- test_data[, -(c(7:23)[-i])]
  
  # 7 = always target CHL i
  CHLi_sample <- 10^test_data_CHLi[, 7]
  
  # === LINEAR ===
  
  formula <- as.formula(paste("`CHL ", i+1, "` ~ .", sep=""))
  reg_linear <- lm(formula, data=train_data_CHLi)
  
  linear_predict <- 10^predict(reg_linear, newdata=test_data_CHLi)
  
  rss_linear <- c(rss_linear, sum((CHLi_sample - linear_predict)^2))
  
  # === FORWARD ===
  
  forward_formula <- as.formula(paste("`CHL ", i+1, "` ~ 1", sep=""))
  reg_forward <- step(lm(forward_formula, data=train_data_CHLi), list(upper=reg_linear), direction="forward", trace=-1)
  
  forward_predict <- 10^predict(reg_forward, newdata=test_data_CHLi)
  
  rss_forward <- c(rss_forward, sum((CHLi_sample - forward_predict)^2))
  
  # === RIDGE ===
  
  library(glmnet)
  
  # remove CHL 2-18 and year (7:24)
  cv_ridge <- cv.glmnet(x=as.matrix(nine_locations[, -(7:24)]), y=nine_locations[,(6+i)], alpha=0)
  
  # 7 = always target
  reg_ridge <- glmnet(x=as.matrix(train_data_CHLi[,-7]), y=train_data_CHLi[,7], alpha=0, lambda=cv_ridge$lambda.min)
  
  ridge_predict <- 10^predict(reg_ridge, newx=as.matrix(test_data_CHLi[,-7]))
  
  rss_ridge <- c(rss_ridge, sum((CHLi_sample - ridge_predict)^2))
  
  # === LASSO ===
  
  # remove CHL 2-18 and year (7:24)
  cv_lasso <- cv.glmnet(x=as.matrix(nine_locations[, -(7:24)]), y=nine_locations[,(6+i)], alpha=1)
  
  # 7 = always target
  reg_lasso <- glmnet(x=as.matrix(train_data_CHLi[,-7]), y=train_data_CHLi[,7], alpha=1, lambda=cv_ridge$lambda.min)
  
  lasso_predict <- 10^predict(reg_lasso, newx=as.matrix(test_data_CHLi[,-7]))
  
  rss_lasso <- c(rss_lasso, sum((CHLi_sample - lasso_predict)^2))
}

plot(rss_linear)
plot(rss_forward)
plot(rss_ridge)
plot(rss_lasso)
```